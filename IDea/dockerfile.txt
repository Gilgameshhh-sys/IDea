# 1. Imagen base ligera de Python
FROM python:3.9-slim

# 2. Evitamos que Python genere archivos .pyc
ENV PYTHONDONTWRITEBYTECODE=1
ENV PYTHONUNBUFFERED=1

WORKDIR /app

# 3. Instalamos dependencias del sistema (si hacen falta compiladores)
RUN apt-get update && apt-get install -y --no-install-recommends gcc

# 4. Copiamos los requerimientos
COPY requirements.txt .

# 5. Instalamos las librerías de Python
# (Aquí irán: fastapi, uvicorn, presidio-analyzer, presidio-anonymizer, spacy)
RUN pip install --no-cache-dir -r requirements.txt

# 6. EL PASO CRÍTICO: Descargar el modelo de Español en el Build Time
# Esto asegura que el modelo quede "quemado" dentro de la imagen Docker.
# 'es_core_news_lg' es el modelo grande (large) para mayor precisión.
RUN python -m spacy download es_core_news_lg

# 7. Copiamos el código de la aplicación
COPY . .

# 8. Exponemos el puerto (por defecto de Cloud Run / Railway suele ser 8080 o variable)
EXPOSE 8080

# 9. Comando de arranque
CMD ["uvicorn", "main:app", "--host", "0.0.0.0", "--port", "8080"]